---
title: "Everything everywhere all at once"
author: "Xiaoshu Lin"
date: "2023-11-01"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
##install.packages("rmarkdown","knitr","readxl","leaps")
knitr::opts_chunk$set(echo = TRUE)
```

See correlations across first degree science. 
```{r}
##install.packages("corrplot","Hmisc")
library(readxl)
First_degree_science <- read_excel("First degree science.xlsx", sheet = "Cleaning")
library(corrplot)
library(Hmisc)
sigcorr1 <- cor.mtest(First_degree_science[,6:11],conf.level = 0.95)
corrplot.mixed(cor(First_degree_science[,6:11],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr1$p, sig.level = .05)
correlation_result1 <- rcorr(as.matrix(First_degree_science[,6:11]))
correlation_matrix1 <- correlation_result1$r
p_values1 <- correlation_result1$P
print(correlation_matrix1)
print(p_values1)
```
The relationship between a focus on the US and NOAA affiliation is not examined since NOAA is a U.S. federal agency, and it is natural that all NOAA produced science cares about the U.S.


Finding the best model using the smallest AIC score. First treat citation outcome as binary. 

```{r}
library(MASS)
logit_model1 <- stepAIC(glm(citation_binary ~ age + socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = First_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model1)
```

Test the heteroskedasticity of the model with the lowest AIC score.

```{r}
fitted_value <- fitted(logit_model1)
residuals <- resid(logit_model1)
heteroskedasticity_test <- lm (fitted_value ~ residuals)
summary(heteroskedasticity_test)
```

```{r}
plot(fitted_value, residuals)
abline(h = 0, col = "salmon")
```

Estimate the marginal effect of NOAA affiliation.

```{r}
##install.packages("margins")
library(margins)
marginal_effect <- margins(glm(citation_binary ~ NOAA_affiliation + age, data = First_degree_science, family = "binomial"), type = "response")
summary(marginal_effect)
```

Next treat citation outcome as continuous.

```{r}
library(leaps)
mod1 <- regsubsets(citation ~ age + socioeconomic + quantitative + NOAA_affiliation + theory, data = First_degree_science)
mod1sum <- summary(mod1)
modnum <- which.max(mod1sum$adjr2)
First_degree_science_temp <- First_degree_science[,c("citation", colnames(mod1sum$which)[mod1sum$which[modnum,] == "TRUE"][-1])]
linear_model1 <- lm(citation ~.,data = First_degree_science_temp)
summary(linear_model1)
```

NOAA Affiliation seems to be the single most powerful indicator of citation outcome. We expand the sample to included indirectly cited science. First let's see correlation.

```{r}
Overall <- read_excel("Second degree science.xlsx", sheet = "Lump")
sigcorr2 <- cor.mtest(Overall[,c(names(Overall)[10:15])],conf.level = 0.99)
corrplot.mixed(cor(Overall[,c(names(Overall)[10:15])],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr2$p, sig.level = .01)
correlation_result2 <- rcorr(as.matrix(Overall[,c(names(Overall)[10:15])]))
correlation_matrix2 <- correlation_result2$r
p_values2 <- correlation_result2$P
print(correlation_matrix2)
print(p_values2)
```


Are there differences between directly cited articles and the rest? Are there differences between cited articles and articles that are not cited at all? Again we are using logit model and treating both citation outcome as binary.

```{r}
logit_model2 <- stepAIC(glm(citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Overall, family = binomial), direction = "both", trace = FALSE)
summary(logit_model2)
logit_model3 <- stepAIC(glm(direct_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Overall, family = binomial), direction = "both", trace = FALSE)
summary(logit_model3)
```

Let's see correlations across directly and indirectly cited science, excluding the academic sample.

```{r}
Second_degree_science <- read_excel("Second degree science.xlsx", sheet = "Cleaning")
sigcorr2 <- cor.mtest(Second_degree_science[,c(names(Second_degree_science)[9:13])],conf.level = 0.99)
corrplot.mixed(cor(Second_degree_science[,c(names(Second_degree_science)[9:13])],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr2$p, sig.level = .01)
correlation_result2 <- rcorr(as.matrix(Second_degree_science[,c(names(Second_degree_science)[9:13])]))
correlation_matrix2 <- correlation_result2$r
p_values2 <- correlation_result2$P
print(correlation_matrix2)
print(p_values2)
```


```{r}
logit_model4 <- stepAIC(glm(direct_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model4)
```

```{r}
mod2 <- regsubsets(direct_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science)
mod2sum <- summary(mod2)
modnum <- which.max(mod2sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("direct_citation", colnames(mod2sum$which)[mod2sum$which[modnum,] == "TRUE"][-1])]
linear_model2 <- lm(direct_citation ~.,data = Second_degree_science_temp)
summary(linear_model2)
```

NOAA affiliation is still the single most predictor of citation outcome. It determines whether a publication is cited at all or not, and whether a publication is directly cited or indirectly cited. 
##Does it determine whether publications are cited more than once or only once? 

```{r}
logit_model4a <- stepAIC(glm(more_than_once_total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model4a)
```

```{r}
mod2 <- regsubsets(total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science)
mod2sum <- summary(mod2)
modnum <- which.max(mod2sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("total_citation", colnames(mod2sum$which)[mod2sum$which[modnum,] == "TRUE"][-1])]
linear_model2a <- lm(total_citation ~.,data = Second_degree_science_temp)
summary(linear_model2a)
```

##Yes it does! 

This time we are focusing on citation by NOAA. There are two samples: one is pure second degree science, meaning science that only shows up in first degree science, not in policy documents; the other includes both first and second degree science.  Before that let's see correlations across the board.

```{r}
Pure_second <- read_excel("Second degree science.xlsx", sheet = "Pure Second Degree Science")
sigcorr3 <- cor.mtest(Pure_second[,9:13],conf.level = 0.9)
corrplot.mixed(cor(Pure_second[,9:13],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr3$p, sig.level = .1)
correlation_result3 <- rcorr(as.matrix(Pure_second[,9:13]))
correlation_matrix3 <- correlation_result3$r
p_values3 <- correlation_result3$P
print(correlation_matrix3)
print(p_values3)
```


Is citation by NOAA a function of what? 

```{r}
logit_model5a <- stepAIC(glm(NOAA_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Pure_second, family = binomial), direction = "both", trace = FALSE)
summary(logit_model5a)
logit_model5b <- stepAIC(glm(NOAA_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model5b)
```

A NOAA publication does not privilege other NOAA publications. Confirm this finding by treating NOAA citation as a continuous outcome.


```{r}
mod3 <- regsubsets(NOAA_citation ~  socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Pure_second)
mod3sum <- summary(mod3)
modnum <- which.max(mod3sum$adjr2)
Pure_second_temp <- Pure_second[,c("NOAA_citation", colnames(mod3sum$which)[mod3sum$which[modnum,] == "TRUE"][-1])]
linear_model3a <- lm(NOAA_citation ~.,data = Pure_second_temp)
summary(linear_model3a)
mod3 <- regsubsets(NOAA_citation ~  socioeconomic + quantitative + NOAA_affiliation + US_focused + theory, data = Second_degree_science)
mod3sum <- summary(mod3)
modnum <- which.max(mod3sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("NOAA_citation", colnames(mod3sum$which)[mod3sum$which[modnum,] == "TRUE"][-1])]
linear_model3b <- lm(NOAA_citation ~.,data = Second_degree_science_temp)
summary(linear_model3b)
```
Review the relationships between first degree science and second degree science using network analysis method to get a lay of the land.

```{r}
##install.packages("igraph")
library(igraph)
Network_analysis <- read_excel("Second degree science.xlsx")
graph <- graph_from_data_frame(Network_analysis, directed = TRUE)
out_degree <- degree(graph, mode = "out")
V(graph)$color <- ifelse(V(graph)$name %in% Network_analysis$to_article, "lightblue","azure" )
V(graph)$size <- ifelse(out_degree > 1, 15, 10)
plot(
  graph,
  edge.arrow.size = 0.5,
  edge.arrow.width = 1,
  edge.width = 1.5,
  main = "Citation Pattern among First- and Second-degree Science"
)
legend("topright",
       legend = c("Cited once", "Cited more than once", "First-degree Science", "Second-degree Science"),
       pch = c(1, 1, 15, 15),  
       col = c("black", "black", "lightblue","azure"), 
       pt.cex = c(1, 1.5, 1.5, 1.5), 
       cex = 1, 
       bty = "n",
       x.intersp = 0.3, 
       y.intersp = 0.4, 
       xjust = 1,  
       yjust = 1)  
```

Visualize the relationship between high citation frequency and other variables. Convert variables into factors before visualization.

```{r}
Second_degree_science$theory_factor <- factor(Second_degree_science$theory,levels = c(0, 1), labels = c("No", "Yes"))
Second_degree_science$NOAA_affiliation_factor <- factor(Second_degree_science$NOAA_affiliation,levels = c(0, 1), labels = c("No", "Yes"))
Second_degree_science$socioeconomic_factor <- factor(Second_degree_science$socioeconomic,levels = c(0, 1), labels = c("No", "Yes"))
Second_degree_science$quantitative_factor <- factor(Second_degree_science$quantitative,levels = c(0, 1), labels = c("No", "Yes"))
Second_degree_science$high_frequency <- factor(Second_degree_science$more_than_once_total_citation,levels = c(0, 1), labels = c("No", "Yes"))
```

Use proportion plots.

```{r}
##install.packages("ggplot2")
library(ggplot2)
ggplot(Second_degree_science, aes(x = high_frequency, fill = socioeconomic_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of High Citation Frequency vs. Socioeconomic Research",
       x = "High Citation Frequency",
       y = "Socioeconomic Research") +
  scale_fill_manual(values = c("Yes" = "cadetblue", "No" = "aquamarine3"))+
  scale_x_discrete(labels = c("No", "Yes"))
```

Visualize the relationship between quantitative method and a focus on the US.

```{r}
ggplot(Second_degree_science, aes(x = high_frequency, fill = NOAA_affiliation_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of High Citation Frequency vs. NOAA Affiliation",
       x = "High Citation Frequency",
       y = "NOAA Affiliation") +
  scale_fill_manual(values = c("Yes" = "lightcyan", "No" = "lightskyblue2"))+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
ggplot(Second_degree_science, aes(x = high_frequency, fill = quantitative_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of High Citation Frequency vs. Quantitative Method",
       x = "High Citation Frequency",
       y = "Quantitative Method") +
  scale_fill_manual(values = c("Yes" = "skyblue", "No" = "steelblue"))+
  scale_x_discrete(labels = c("No", "Yes"))
```

```{r}
ggplot(Second_degree_science, aes(x = high_frequency, fill = theory_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of High Citation Frequency vs. Theory",
       x = "High Citation Frequency",
       y = "Theory") +
  scale_fill_manual(values = c("Yes" = "seagreen", "No" = "paleturquoise4"))+
  scale_x_discrete(labels = c("No", "Yes"))
```



