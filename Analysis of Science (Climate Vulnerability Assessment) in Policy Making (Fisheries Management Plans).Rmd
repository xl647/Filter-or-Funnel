---
title: "Everything everywhere all at once"
author: "Xiaoshu Lin"
date: "2023-11-01"
output:
  word_document: default
  html_document: default
---

```{r setup, include=FALSE}
##install.packages("rmarkdown","knitr","readxl","leaps")
knitr::opts_chunk$set(echo = TRUE)
```

Import raw data and review the data.

```{r}
library(readxl)
First_degree_science <- read_excel("First degree science.xlsx", sheet = "Cleaning")
```

See correlations across the board. 
```{r}
##install.packages("corrplot","Hmisc")
library(corrplot)
library(Hmisc)
sigcorr1 <- cor.mtest(First_degree_science[,4:9],conf.level = 0.9)
corrplot.mixed(cor(First_degree_science[,4:9],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr1$p, sig.level = .1)
correlation_result1 <- rcorr(as.matrix(First_degree_science[,4:9]))
correlation_matrix1 <- correlation_result1$r
p_values1 <- correlation_result1$P
print(correlation_matrix1)
print(p_values1)
```

Finding the best model using the smallest AIC score. First treat citation outcome as binary. 

```{r}
library(MASS)
logit_model1 <- stepAIC(glm(citation_binary ~ age + socioeconomic + quantitative + NOAA_affiliation + US_focused, data = First_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model1)
```

Test the heteroskedasticity of the model with the lowest AIC score.

```{r}
fitted_value <- fitted(logit_model1)
residuals <- resid(logit_model1)
heteroskedasticity_test <- lm (fitted_value ~ residuals)
summary(heteroskedasticity_test)
```

```{r}
plot(fitted_value, residuals)
abline(h = 0, col = "salmon")
```

Estimate the marginal effect of NOAA affiliation.

```{r}
##install.packages("margins")
library(margins)
marginal_effect <- margins(glm(citation_binary ~ NOAA_affiliation + age, data = First_degree_science, family = "binomial"), type = "response")
summary(marginal_effect)
```



Next treat citation outcome as continuous.

```{r}
library(leaps)
mod1 <- regsubsets(citation ~ age + socioeconomic + quantitative + NOAA_affiliation + US_focused, data = First_degree_science)
mod1sum <- summary(mod1)
modnum <- which.max(mod1sum$adjr2)
First_degree_science_temp <- First_degree_science[,c("citation", colnames(mod1sum$which)[mod1sum$which[modnum,] == "TRUE"][-1])]
linear_model1 <- lm(citation ~.,data = First_degree_science_temp)
summary(linear_model1)
```

NOAA Affiliation seems to be the single most powerful indicator of citation outcome. 

Visualize the relationship between age and citation outcome. Convert variables into factors before visualization.

```{r}
First_degree_science$citation_factor <- factor(First_degree_science$citation_binary,levels = c(0, 1), labels = c("No", "Yes"))
First_degree_science$NOAA_affiliation_factor <- factor(First_degree_science$NOAA_affiliation,levels = c(0, 1), labels = c("No", "Yes"))
boxplot(age~citation_factor, data=First_degree_science, horizontal = TRUE, main = "Box Plot of Age vs. Citation",  xlab = "Age", ylab = "Citation", col=c("seagreen","paleturquoise4"))
```

Visualize the relationship between age and NOAA Affiliation.

```{r}
boxplot(age~NOAA_affiliation_factor, data=First_degree_science, horizontal = TRUE, main = "Box Plot of Age vs. NOAA Affiliation",  xlab = "Age", ylab = "NOAA Affiliation", col=c("skyblue","steelblue"))
```

Visualize the relationship between socioeconomic and NOAA Affiliation.

```{r}
First_degree_science$socioeconomic_factor <- factor(First_degree_science$socioeconomic,levels = c(0, 1), labels = c("No", "Yes"))
First_degree_science$quantitative_factor <- factor(First_degree_science$quantitative,levels = c(0, 1), labels = c("No", "Yes"))
First_degree_science$US_focused_factor <- factor(First_degree_science$US_focused,levels = c(0, 1), labels = c("No", "Yes"))
##install.packages("ggplot2")
library(ggplot2)
ggplot(First_degree_science, aes(x = NOAA_affiliation_factor, fill = socioeconomic_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of NOAA Affiliation vs. Socioeconomic Research",
       x = "NOAA Affiliation",
       y = "Socioeconomic Research") +
  scale_fill_manual(values = c("Yes" = "cadetblue", "No" = "aquamarine3"))+
  scale_x_discrete(labels = c("No", "Yes"))
```

Visualize the relationship between quantitative method and a focus on the US.

```{r}
ggplot(First_degree_science, aes(x = US_focused_factor, fill = quantitative_factor)) +
  geom_bar(position = "fill") +
  labs(title = "Proportion Plot of Quantitative Method vs. US Focus",
       x = "US Focus",
       y = "Quantitative Method") +
  scale_fill_manual(values = c("Yes" = "lightcyan", "No" = "lightskyblue2"))+
  scale_x_discrete(labels = c("No", "Yes"))
```
The relationship between a focus on the US and NOAA affiliation is not examined since NOAA is a U.S. federal agency, and it is natural that all NOAA produced science cares about the U.S.

Analyze the relationships between first degree science and second degree science using network analysis method.

```{r}
##install.packages("igraph")
library(igraph)
Network_analysis <- read_excel("Second degree science.xlsx")
graph <- graph_from_data_frame(Network_analysis, directed = TRUE)
out_degree <- degree(graph, mode = "out")
V(graph)$color <- ifelse(V(graph)$name %in% Network_analysis$to_article, "lightblue","azure" )
V(graph)$size <- ifelse(out_degree > 1, 15, 10)
plot(
  graph,
  edge.arrow.size = 0.5,
  edge.arrow.width = 1,
  edge.width = 1.5,
  main = "Citation Pattern among First- and Second-degree Science"
)
legend("topright",
       legend = c("Cited once", "Cited more than once", "First-degree Science", "Second-degree Science"),
       pch = c(1, 1, 15, 15),  
       col = c("black", "black", "lightblue","azure"), 
       pt.cex = c(1, 1.5, 1.5, 1.5), 
       cex = 1, 
       bty = "n",
       x.intersp = 0.3, 
       y.intersp = 0.4, 
       xjust = 1,  
       yjust = 1)  
```

Are there differences between cited articles and articles that are not cited at all? Are there differences between directly cited articles and the rest? Again we are using logit model and treating both citation outcome as binary.

```{r}
Overall <- read_excel("Second degree science.xlsx", sheet = "Lump")
logit_model2 <- stepAIC(glm(citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Overall, family = binomial), direction = "both", trace = FALSE)
summary(logit_model2)
logit_model3 <- stepAIC(glm(direct_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Overall, family = binomial), direction = "both", trace = FALSE)
summary(logit_model3)
```

Next we focus on variation across directly and indirectly cited science, excluding the academic sample, and look for the best model. Before that let's see correlations across the board.

```{r}
Second_degree_science <- read_excel("Second degree science.xlsx", sheet = "Cleaning")
sigcorr2 <- cor.mtest(Second_degree_science[,c("direct_citation_binary", names(Second_degree_science)[7:12])],conf.level = 0.9)
corrplot.mixed(cor(Second_degree_science[,c("direct_citation_binary", names(Second_degree_science)[7:12])],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr2$p, sig.level = .1)
correlation_result2 <- rcorr(as.matrix(Second_degree_science[,c("direct_citation_binary", names(Second_degree_science)[7:12])]))
correlation_matrix2 <- correlation_result2$r
p_values2 <- correlation_result2$P
print(correlation_matrix2)
print(p_values2)
```


```{r}
logit_model4 <- stepAIC(glm(direct_citation_binary ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model4)
```

```{r}
mod2 <- regsubsets(direct_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science)
mod2sum <- summary(mod2)
modnum <- which.max(mod2sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("direct_citation", colnames(mod2sum$which)[mod2sum$which[modnum,] == "TRUE"][-1])]
linear_model2 <- lm(direct_citation ~.,data = Second_degree_science_temp)
summary(linear_model2)
```

NOAA affiliation is still the single most predictor of citation outcome. It determines whether a publication is cited at all or not, and whether a publication is directly cited or indirectly cited. Does it determine whether publications are cited more than once or only once? 

```{r}
logit_model4a <- stepAIC(glm(more_than_once_total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model4a)
```

```{r}
mod2 <- regsubsets(total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science)
mod2sum <- summary(mod2)
modnum <- which.max(mod2sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("total_citation", colnames(mod2sum$which)[mod2sum$which[modnum,] == "TRUE"][-1])]
linear_model2a <- lm(total_citation ~.,data = Second_degree_science_temp)
summary(linear_model2a)
```

Yes it does! This time focusing on pure second degree science, no matter what kind of first-degree science cite it, NOAA or non-NOAA. In this case total citation equals indirect citation. Before that let's see correlations across the board.

```{r}
Pure_second <- read_excel("Second degree science.xlsx", sheet = "Pure Second Degree Science")
sigcorr3 <- cor.mtest(Pure_second[,7:12],conf.level = 0.9)
corrplot.mixed(cor(Pure_second[,7:12],use = "pairwise.complete.obs"), upper = "ellipse", tl.col = "black", number.cex = .7, tl.pos = "lt", tl.cex=.7, p.mat = sigcorr3$p, sig.level = .1)
correlation_result3 <- rcorr(as.matrix(Pure_second[,7:12]))
correlation_matrix3 <- correlation_result3$r
p_values3 <- correlation_result3$P
print(correlation_matrix3)
print(p_values3)
```

```{r}
logit_model4e <- stepAIC(glm(more_than_once_total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Pure_second, family = binomial), direction = "both", trace = FALSE)
summary(logit_model4e)
```

```{r}
mod2 <- regsubsets(total_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Pure_second)
mod2sum <- summary(mod2)
modnum <- which.max(mod2sum$adjr2)
Pure_second_temp <- Pure_second[,c("total_citation", colnames(mod2sum$which)[mod2sum$which[modnum,] == "TRUE"][-1])]
linear_model2e <- lm(total_citation ~.,data = Pure_second_temp)
summary(linear_model2e)
```

Is citation by NOAA a factor of NOAA affiliation? 

```{r}
logit_model5a <- stepAIC(glm(NOAA_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science, family = binomial), direction = "both", trace = FALSE)
summary(logit_model5a)
logit_model5b <- stepAIC(glm(NOAA_citation ~ socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Pure_second, family = binomial), direction = "both", trace = FALSE)
summary(logit_model5b)
```

A NOAA publication does not privilege other NOAA publications. Confirm this finding by treating NOAA citation as a continuous outcome.


```{r}
mod3 <- regsubsets(NOAA_citation ~  socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Second_degree_science)
mod3sum <- summary(mod3)
modnum <- which.max(mod3sum$adjr2)
Second_degree_science_temp <- Second_degree_science[,c("NOAA_citation", colnames(mod3sum$which)[mod3sum$which[modnum,] == "TRUE"][-1])]
linear_model3a <- lm(NOAA_citation ~.,data = Second_degree_science_temp)
summary(linear_model3a)
mod3 <- regsubsets(NOAA_citation ~  socioeconomic + quantitative + NOAA_affiliation + US_focused, data = Pure_second)
mod3sum <- summary(mod3)
modnum <- which.max(mod3sum$adjr2)
Pure_second_temp <- Pure_second[,c("NOAA_citation", colnames(mod3sum$which)[mod3sum$which[modnum,] == "TRUE"][-1])]
linear_model3b <- lm(NOAA_citation ~.,data = Pure_second_temp)
summary(linear_model3b)
```











